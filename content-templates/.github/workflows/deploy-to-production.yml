# Content Deployment Workflow - AMU Platform
#
# Validates and deploys course content to production.
# Triggers on push to main branch.
#
# "Ubuntu - I am because we are"

name: Deploy Content to Production

on:
  push:
    branches:
      - main
    paths:
      - 'courses/**'
      - 'email-templates/**'
      - 'ui-text/**'
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all cached content'
        required: false
        default: 'false'

env:
  AMU_API_URL: ${{ secrets.AMU_API_URL }}
  AMU_CONTENT_WEBHOOK_SECRET: ${{ secrets.AMU_CONTENT_WEBHOOK_SECRET }}

jobs:
  validate:
    name: Validate Content
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install ajv ajv-formats

      - name: Validate module.json files
        run: |
          echo "Validating module.json files..."
          for file in courses/**/module.json; do
            if [ -f "$file" ]; then
              echo "Validating: $file"
              node -e "
                const Ajv = require('ajv');
                const addFormats = require('ajv-formats');
                const fs = require('fs');

                const schema = {
                  type: 'object',
                  required: ['module_id', 'module_title', 'module_version', 'module_learning_outcomes'],
                  properties: {
                    module_id: { type: 'string', minLength: 1 },
                    module_title: { type: 'string', minLength: 1 },
                    module_description: { type: 'string' },
                    module_version: { type: 'string', pattern: '^[0-9]+\\.[0-9]+\\.[0-9]+$' },
                    module_last_updated: { type: 'string', format: 'date' },
                    module_estimated_duration_minutes: { type: 'integer', minimum: 1 },
                    module_nqf_level: { type: 'integer', minimum: 1, maximum: 10 },
                    module_credits: { type: 'integer', minimum: 0 },
                    module_learning_outcomes: { type: 'array', minItems: 1 }
                  }
                };

                const ajv = new Ajv();
                addFormats(ajv);
                const validate = ajv.compile(schema);
                const data = JSON.parse(fs.readFileSync('$file', 'utf8'));

                if (!validate(data)) {
                  console.error('Validation errors:', validate.errors);
                  process.exit(1);
                }
                console.log('Valid!');
              "
            fi
          done

      - name: Validate competencies.json files
        run: |
          echo "Validating competencies.json files..."
          for file in courses/**/competencies.json; do
            if [ -f "$file" ]; then
              echo "Validating: $file"
              node -e "
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('$file', 'utf8'));

                if (!data.competencies || !Array.isArray(data.competencies)) {
                  console.error('Missing competencies array');
                  process.exit(1);
                }

                for (const comp of data.competencies) {
                  if (!comp.competency_id || !comp.competency_title) {
                    console.error('Invalid competency:', comp);
                    process.exit(1);
                  }
                }
                console.log('Valid!');
              "
            fi
          done

      - name: Check markdown files exist
        run: |
          echo "Checking required markdown files..."
          for module_dir in courses/*/*/; do
            if [ -d "$module_dir" ]; then
              echo "Checking: $module_dir"
              for required_file in case-study.md discovery-questions.md; do
                if [ ! -f "${module_dir}${required_file}" ]; then
                  echo "Warning: Missing ${module_dir}${required_file}"
                fi
              done
            fi
          done

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify AMU Platform of Content Update
        run: |
          # Calculate which modules changed
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          # Extract course and module IDs from changed paths
          MODULES_TO_REFRESH=""
          for file in $CHANGED_FILES; do
            if [[ $file == courses/*/* ]]; then
              COURSE_ID=$(echo $file | cut -d'/' -f2)
              MODULE_ID=$(echo $file | cut -d'/' -f3)
              MODULES_TO_REFRESH="$MODULES_TO_REFRESH$COURSE_ID/$MODULE_ID "
            fi
          done

          # If force refresh or no specific modules, refresh all
          if [ "${{ github.event.inputs.force_refresh }}" == "true" ] || [ -z "$MODULES_TO_REFRESH" ]; then
            echo "Triggering full cache refresh..."
            curl -X POST \
              -H "Authorization: Bearer $AMU_CONTENT_WEBHOOK_SECRET" \
              -H "Content-Type: application/json" \
              "${AMU_API_URL}/api/content/refresh" \
              -d '{"refresh_all": true}'
          else
            echo "Refreshing specific modules: $MODULES_TO_REFRESH"
            for module in $MODULES_TO_REFRESH; do
              COURSE_ID=$(echo $module | cut -d'/' -f1)
              MODULE_ID=$(echo $module | cut -d'/' -f2)
              curl -X POST \
                -H "Authorization: Bearer $AMU_CONTENT_WEBHOOK_SECRET" \
                -H "Content-Type: application/json" \
                "${AMU_API_URL}/api/content/refresh" \
                -d "{\"course_id\": \"$COURSE_ID\", \"module_id\": \"$MODULE_ID\"}"
            done
          fi

      - name: Post to Slack (optional)
        if: success()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST \
              -H 'Content-type: application/json' \
              --data '{"text":"AMU Content deployed successfully from commit ${{ github.sha }}"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "Content deployment failed. Check the workflow logs for details."
          # Add notification logic here (email, Slack, etc.)
