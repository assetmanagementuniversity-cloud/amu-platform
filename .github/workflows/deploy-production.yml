name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deploy only)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  GCP_PROJECT_ID: amu-platform-production
  GCP_REGION: africa-south1
  GCP_FAILOVER_REGION: europe-west1
  CLOUD_RUN_SERVICE_API: amu-api
  CLOUD_RUN_SERVICE_WEB: amu-web

jobs:
  # Run tests before production deployment
  pre-deploy-tests:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run type check
        run: npm run type-check

      - name: Run tests
        run: npm test -- --passWithNoTests
        env:
          CI: true

  deploy-api:
    name: Deploy API to Production
    runs-on: ubuntu-latest
    environment: production
    needs: [pre-deploy-tests]
    if: ${{ always() && (needs.pre-deploy-tests.result == 'success' || github.event.inputs.skip_tests == 'true') }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build API
        run: npm run build --workspace=apps/api

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and push Docker image
        run: |
          gcloud builds submit apps/api \
            --tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE_API }}:${{ github.sha }} \
            --tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE_API }}:latest

      - name: Deploy to Cloud Run (Primary - Africa South)
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE_API }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE_API }}:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 1 \
            --max-instances 100 \
            --memory 512Mi \
            --cpu 1 \
            --set-env-vars "NODE_ENV=production" \
            --set-secrets "ANTHROPIC_API_KEY=anthropic-api-key:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest,STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest,FIREBASE_SERVICE_ACCOUNT=firebase-service-account:latest,SIGNREQUEST_API_TOKEN=signrequest-api-token:latest"

      - name: Deploy to Cloud Run (Failover - Europe West)
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE_API }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE_API }}:${{ github.sha }} \
            --region ${{ env.GCP_FAILOVER_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 50 \
            --memory 512Mi \
            --cpu 1 \
            --set-env-vars "NODE_ENV=production" \
            --set-secrets "ANTHROPIC_API_KEY=anthropic-api-key:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest,STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest,FIREBASE_SERVICE_ACCOUNT=firebase-service-account:latest,SIGNREQUEST_API_TOKEN=signrequest-api-token:latest"

  deploy-web:
    name: Deploy Web to Production
    runs-on: ubuntu-latest
    environment: production
    needs: [deploy-api]
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Web App
        run: npm run build --workspace=apps/web
        env:
          NEXT_PUBLIC_API_URL: https://api.assetmanagementuniversity.org
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and push Docker image
        run: |
          gcloud builds submit apps/web \
            --tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE_WEB }}:${{ github.sha }} \
            --tag gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE_WEB }}:latest

      - name: Deploy to Cloud Run (Primary - Africa South)
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE_WEB }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE_WEB }}:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 1 \
            --max-instances 100 \
            --memory 1Gi \
            --cpu 1

      - name: Deploy to Cloud Run (Failover - Europe West)
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE_WEB }} \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/${{ env.CLOUD_RUN_SERVICE_WEB }}:${{ github.sha }} \
            --region ${{ env.GCP_FAILOVER_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 50 \
            --memory 1Gi \
            --cpu 1

  notify-deployment:
    name: Notify Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-web]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Primary Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failover Region:** ${{ env.GCP_FAILOVER_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Web: https://assetmanagementuniversity.org" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://api.assetmanagementuniversity.org" >> $GITHUB_STEP_SUMMARY
